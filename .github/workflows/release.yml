name: Build and Release

on:
  push:
    branches: [ release ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true

    - name: Extract version
      id: extract_version
      shell: pwsh
      run: |
        $content = Get-Content -Path README.md -Raw
        $version = [regex]::Match($content, '# Reboot Reminder (v[\d\.\-]+)').Groups[1].Value
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT

    - name: Build Release
      run: |
        .\build.bat

    - name: Create Release Package
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Path .\release -Force
        Copy-Item .\target\release\reboot_reminder.exe .\release\
        Copy-Item .\README.md .\release\
        Copy-Item .\LICENSE .\release\
        Copy-Item .\config\*.json .\release\
        Copy-Item .\config\*.xml .\release\

        # Create release-packages directory if it doesn't exist
        New-Item -ItemType Directory -Path .\release-packages -Force

        # Create the release package
        Compress-Archive -Path .\release\* -DestinationPath .\release-packages\RebootReminder-${{ steps.extract_version.outputs.VERSION }}.zip -Force

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.extract_version.outputs.VERSION }}
        release_name: Reboot Reminder ${{ steps.extract_version.outputs.VERSION }}
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release-packages/RebootReminder-${{ steps.extract_version.outputs.VERSION }}.zip
        asset_name: RebootReminder-${{ steps.extract_version.outputs.VERSION }}.zip
        asset_content_type: application/zip
